{% extends 'layout.html' %}
{% block title %}Video Emotion Analysis Results{% endblock %}
{% block extra_css %}
<style>
    .header {
        background: linear-gradient(to right, #4a00e0, #8e2de2);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 15px 15px;
    }
    .main-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 1.5rem;
    }
    .summary-card {
        border-left: 5px solid #8e2de2;
        background-color: #f8f9fa;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 5px;
    }
    .emotion-bar {
        height: 20px;
        border-radius: 10px;
        transition: width 0.5s ease;
        color: white;
        text-align: center;
        font-size: 0.8rem;
        line-height: 20px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .frame-container {
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 1rem;
    }
    .frame-image {
        width: 100%;
        border-radius: 5px;
    }
    .frame-slider {
        margin: 1rem 0;
    }
    .badge-emotion {
        font-size: 1rem;
        padding: 0.5rem;
        margin-right: 0.5rem;
    }
    .timeline-section {
        overflow-x: auto;
    }
    .video-player {
        width: 100%;
        border-radius: 10px;
        box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.15);
    }
    .stats-item {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }
    .stats-icon {
        font-size: 1.5rem;
        margin-right: 1rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #e9ecef;
        border-radius: 50%;
    }
    .frame-details-section {
        max-height: 400px;
        overflow-y: auto;
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 5px;
    }
    .frame-item {
        padding: 0.5rem;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
    }
    .frame-item:hover {
        background-color: #f8f9fa;
    }
    .frame-item.active {
        background-color: #e9ecef;
    }
    .progress-bar {
        border-radius: 5px;
    }
</style>
{% endblock %}
{% block content %}
<!-- Header Section -->
<div class="header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1>Video Emotion Analysis Results</h1>
                <p class="lead mb-0">Detailed analysis of facial emotions and scene context</p>
            </div>
            <div class="col-md-4 text-md-end">
                <a href="{{ url_for('home') }}" class="btn btn-light">
                    <i class="fas fa-home me-2"></i>Home
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Video and Key Stats -->
    <div class="row">
        <!-- Video Player -->
        <div class="col-md-6 mb-4">
            <div class="main-container">
                <h3><i class="fas fa-video me-2"></i>Original Video</h3>
                <div class="ratio ratio-16x9 mt-3">
                    <video class="video-player" controls>
                        <source src="{{ url_for('static', filename='uploads/' + video_path) }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted">{{ video_filename }}</small>
                </div>
            </div>
        </div>
        
        <!-- Key Stats Summary -->
        <div class="col-md-6 mb-4">
            <div class="main-container">
                <h3><i class="fas fa-chart-pie me-2"></i>Key Findings</h3>
                
                <div class="summary-card mt-3">
                    <div class="stats-item">
                        <div class="stats-icon">
                            <i class="fas fa-smile"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Primary Emotion</h5>
                            <p class="mb-0"><strong>{{ primary_emotion }}</strong></p>
                        </div>
                    </div>
                    
                    <div class="stats-item">
                        <div class="stats-icon">
                            <i class="fas fa-image"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Dominant Scene</h5>
                            <p class="mb-0"><strong>{{ dominant_theme }}</strong></p>
                        </div>
                    </div>
                    
                    <div class="stats-item">
                        <div class="stats-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Average Faces Detected</h5>
                            <p class="mb-0"><strong>{{ face_count }}</strong> per frame</p>
                        </div>
                    </div>
                    
                    <div class="stats-item">
                        <div class="stats-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Duration</h5>
                            <p class="mb-0"><strong>{{ summary.duration|round(1) }}</strong> seconds</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Emotion Analysis Section -->
    <div class="row">
        <!-- Emotion Distribution Chart -->
        <div class="col-md-6 mb-4">
            <div class="main-container">
                <h3><i class="fas fa-heart me-2"></i>Emotion Distribution</h3>
                <div class="chart-container">
                    <canvas id="emotionPieChart"></canvas>
                </div>
                <div class="mt-3">
                    {% for emotion, value in emotions.items() %}
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span>{{ emotion }}</span>
                                <span>{{ value|round(1) }}%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ value }}%; background-color: {{ ['rgba(255, 99, 132, 0.8)', 'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 206, 86, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 159, 64, 0.8)', 'rgba(201, 203, 207, 0.8)'][loop.index0 % 7] }}" 
                                     aria-valuenow="{{ value }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Scene Context Chart -->
        <div class="col-md-6 mb-4">
            <div class="main-container">
                <h3><i class="fas fa-film me-2"></i>Scene Context</h3>
                <div class="chart-container">
                    <canvas id="sceneContextChart"></canvas>
                </div>
                <div class="mt-3">
                    {% for label, value in topics %}
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span>{{ label }}</span>
                                <span>{{ (value * 100)|round(1) }}%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-info" role="progressbar" 
                                     style="width: {{ (value * 100)|default(0) }}%;"
                                     aria-valuenow="{{ (value * 100)|default(0) }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Emotional Timeline Section -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="main-container timeline-section">
                <h3><i class="fas fa-chart-line me-2"></i>Emotional Timeline</h3>
                <div class="chart-container">
                    <canvas id="emotionTimeline"></canvas>
                </div>
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    The timeline shows how emotions change throughout the video.
                </div>
            </div>
        </div>
    </div>
    
    <!-- Frame-by-Frame Analysis -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="main-container">
                <h3><i class="fas fa-photo-video me-2"></i>Frame-by-Frame Analysis</h3>
                
                <div class="row mt-3">
                    <!-- Frame Image Display -->
                    <div class="col-md-7 mb-3">
                        <div class="frame-container">
                            <img id="frameImage" class="frame-image img-fluid" src="{{ frame_details[0].image_url if frame_details else '' }}" alt="Frame">
                            <input type="range" class="form-range frame-slider" id="frameSlider" min="0" max="{{ frame_details|length - 1 if frame_details else 0 }}" value="0">
                            <div class="d-flex justify-content-between text-muted">
                                <small>Start</small>
                                <small>End</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Frame Details -->
                    <div class="col-md-5 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                Frame Details
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong>Timestamp:</strong>
                                    <span id="timeDisplay">{{ frame_details[0].time if frame_details else '0.00s' }}</span>
                                </div>
                                <div class="mb-3">
                                    <strong>Primary Emotion:</strong>
                                    <span id="primaryEmotion">{{ frame_details[0].primary_emotion if frame_details else 'Unknown' }}</span>
                                </div>
                                <div class="mb-3">
                                    <strong>Faces Detected:</strong>
                                    <span id="faceCount">{{ frame_details[0].face_count if frame_details else '0' }}</span>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Emotions:</strong>
                                    {% if frame_details and frame_details[0].emotions %}
                                        {% for emotion, value in frame_details[0].emotions.items() %}
                                            <div class="mt-1">
                                                <small>{{ emotion }}</small>
                                                <div class="progress">
                                                    <div id="emotion-{{ emotion.lower().replace(' ', '-') }}" class="progress-bar emotion-bar" 
                                                         style="width: {{ value * 100 }}%; background-color: {{ ['rgba(255, 99, 132, 0.8)', 'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 206, 86, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 159, 64, 0.8)', 'rgba(201, 203, 207, 0.8)'][loop.index0 % 7] }}">
                                                        {{ (value * 100)|round(1) }}%
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-muted">No emotion data for this frame</p>
                                    {% endif %}
                                </div>
                                
                                <div>
                                    <strong>Scene Context:</strong>
                                    {% if frame_details and frame_details[0].content %}
                                        {% for context, value in frame_details[0].content.items() %}
                                            <div class="mt-1">
                                                <small>{{ context }}</small>
                                                <div class="progress">
                                                    <div id="context-{{ context.lower().replace(' ', '-') }}" class="progress-bar emotion-bar bg-info" 
                                                          style="width: {{ (value * 100)|default(0) }}%; background-color: {{ ['rgba(255, 99, 132, 0.8)', 'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 206, 86, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 159, 64, 0.8)', 'rgba(201, 203, 207, 0.8)'][loop.index0 % 7] }}">
                                                        {{ (value * 100)|round(1) }}%
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-muted">No context data for this frame</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Frame Thumbnails -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="main-container">
                <h3><i class="fas fa-images me-2"></i>Analyzed Frames</h3>
                <div class="mt-3 frame-details-section" id="frameDetails">
                    <div class="row row-cols-2 row-cols-md-4 row-cols-xl-6 g-3">
                        {% for frame in frame_details %}
                            <div class="col">
                                <div class="card h-100 frame-item" data-index="{{ loop.index0 }}">
                                    <img src="{{ frame.image_url }}" class="card-img-top" alt="Frame at {{ frame.time }}">
                                    <div class="card-body p-2">
                                        <p class="card-text mb-1 text-center">
                                            <small>{{ frame.time }}</small>
                                        </p>
                                        <p class="card-text mb-0 text-center">
                                            <span class="badge {{ 'bg-success' if frame.primary_emotion == 'Happy' else 'bg-primary' if frame.primary_emotion == 'Neutral' else 'bg-warning' if frame.primary_emotion == 'Surprise' else 'bg-danger' if frame.primary_emotion in ['Angry', 'Disgust', 'Fear'] else 'bg-info' if frame.primary_emotion == 'Sad' else 'bg-secondary' }}">
                                                {{ frame.primary_emotion }}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Analysis Metadata -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="main-container">
                <h3><i class="fas fa-info-circle me-2"></i>Analysis Details</h3>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Analysis ID</span>
                                <span class="text-muted">{{ analysis_id }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Video file</span>
                                <span class="text-muted">{{ video_filename }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Duration</span>
                                <span class="text-muted">{{ summary.duration|round(1) }} seconds</span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Frames analyzed</span>
                                <span class="text-muted">{{ summary.frames_analyzed }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Frames with faces</span>
                                <span class="text-muted">{{ summary.frames_with_faces }} ({{ summary.face_detection_rate|round(1) }}%)</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Analysis time</span>
                                <span class="text-muted">{{ summary.analysis_duration|round(2) }} seconds</span>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <a href="{{ url_for('home') }}" class="btn btn-primary">
                        <i class="fas fa-home me-2"></i>Back to Home
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" defer></script>
<script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/chart.js') }}" defer></script>
<script id="emotionLabelsData" type="application/json">
    {{ emotion_labels|tojson|default('[]') }}
</script>
<script id="emotionValuesData" type="application/json">
    {{ emotion_values|tojson|default('[]') }}
</script>
<script id="contentLabelsData" type="application/json">
    {{ content_labels|tojson|default('[]') }}
</script>
<script id="contentValuesData" type="application/json">
    {{ content_values|tojson|default('[]') }}
</script>
<script id="timelineLabelsData" type="application/json">
    {{ timeline_labels|tojson|default('[]') }}
</script>
<script id="emotionTimelineData" type="application/json">
    [{% for item in summary.emotional_timeline %}
        {"timestamp": {{ item.timestamp|default(0) }}, "emotion": "{{ item.emotion|default('Unknown') }}", "intensity": {{ item.intensity|default(0) }}}{{ "," if not loop.last }}
    {% endfor %}]
</script>
<script id="frameDetailsData" type="application/json">
    {{ frame_details|tojson|default('[]') }}
</script>
<script>
    // Ensure Chart.js is loaded before initializing charts
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof Chart === 'undefined') {
            console.error('Chart.js not loaded. Charts will not be displayed.');
            return;
        }
        // Thumbnail click handler
        document.querySelectorAll('.frame-item').forEach(item => {
            item.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                const slider = document.getElementById('frameSlider');
                if (slider) {
                    slider.value = index;
                    const event = new Event('input');
                    slider.dispatchEvent(event);
                    document.querySelectorAll('.frame-item').forEach(frame => {
                        frame.classList.remove('active');
                    });
                    this.classList.add('active');
                }
            });
        });
    });
</script>
{% endblock %}